<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dify API 对话客户端 · Zeabur 部署优化版</title>
    <style>
        /* --- 全局样式 --- */
        :root {
            --primary-color: #4A90E2;
            --user-bg: #4A90E2;
            --ai-bg: #f0f2f5;
            --text-light: #ffffff;
            --text-dark: #333333;
            --bg-color: #ffffff;
            --border-color: #e0e0e0;
            --config-bg: #f9fafb;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            margin: 0;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--text-dark);
        }

        .main-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* --- 顶部配置区域 --- */
        .config-section {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--config-bg);
            flex-shrink: 0;
        }
        .config-section summary {
            font-size: 1.5em;
            font-weight: 600;
            cursor: pointer;
            padding: 10px 0;
        }
        .config-section summary::-webkit-details-marker {
            display: none;
        }
        .config-section summary::before {
            content: '▶';
            margin-right: 10px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        .config-section p {
            color: #666;
            margin-top: 5px;
        }
        .config-content {
            margin-top: 15px;
        }
        .config-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .config-item label {
            width: 120px;
            font-weight: 500;
            flex-shrink: 0;
        }
        .config-item input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        .config-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .config-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .save-btn {
            background-color: var(--primary-color);
            color: var(--text-light);
        }
        .new-chat-btn {
            background-color: var(--ai-bg);
            color: var(--text-dark);
        }


        /* --- 聊天区域 --- */
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .message-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .message-container {
            display: flex;
            flex-direction: column;
        }
        .user-message {
            background-color: var(--user-bg);
            color: var(--text-light);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            background-color: var(--bg-color);
            color: var(--text-dark);
            align-self: flex-start;
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        .loading-dots { display: inline-block; }
        .loading-dots span { display: inline-block; width: 8px; height: 8px; background-color: currentColor; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        /* --- 输入区域 --- */
        .input-area {
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            background-color: #fff;
            flex-shrink: 0;
        }
        .input-area input { flex-grow: 1; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 20px; font-size: 16px; margin-right: 10px; }
        .input-area input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2); }
        .input-area button { width: 80px; border: none; background-color: var(--primary-color); color: var(--text-light); border-radius: 20px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        .input-area button:disabled { background-color: #a0a0a0; cursor: not-allowed; }

        /* 移动端适配 */
        @media (max-width: 600px) {
            .config-item{
                flex-direction: column;
                align-items: flex-start;
            }
            .config-item label {
                margin-bottom: 5px;
            }
            .config-item input {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="config-section">
            <details open>
                <summary>Dify API 对话客户端</summary>
                <div class="config-content">
                    <p>⚡ 本版特点：界面清爽，配置清晰，专为 Zeabur 一键部署优化。</p>
                    <div class="config-item">
                        <label for="apiUrl">API Base URL</label>
                        <input type="text" id="apiUrl" placeholder="你的 Dify API 地址, 例如: http://your-dify-url/v1">
                    </div>
                    <div class="config-item">
                        <label for="apiKey">API Key</label>
                        <input type="password" id="apiKey" placeholder="你的 Dify API Key">
                    </div>
                    <div class="config-buttons">
                        <button class="save-btn" onclick="saveConfig()">保存配置</button>
                        <button class="new-chat-btn" onclick="newConversation()">新对话</button>
                    </div>
                </div>
            </details>
        </div>

        <div class="chat-container" id="chat-container">
            <!-- 聊天消息会在这里动态添加 -->
        </div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="输入你的问题..." onkeydown="handleEnter(event)">
            <button id="sendButton" onclick="sendMessage()">发送</button>
        </div>
    </div>

    <script>
        // --- 核心 JavaScript 逻辑 (与之前版本相同) ---
        const apiUrlInput = document.getElementById('apiUrl');
        const apiKeyInput = document.getElementById('apiKey');
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');

        let conversationId = null;

        window.onload = () => {
            apiUrlInput.value = localStorage.getItem('difyApiUrl') || '';
            apiKeyInput.value = localStorage.getItem('difyApiKey') || '';
        };

        function saveConfig() {
            localStorage.setItem('difyApiUrl', apiUrlInput.value);
            localStorage.setItem('difyApiKey', apiKeyInput.value);
            alert('配置已保存！');
        }

        function newConversation() {
            conversationId = null;
            chatContainer.innerHTML = '';
        }

        function handleEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function addMessage(text, sender, elementId = null) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container';
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${sender}-message`;
            if (elementId) messageBubble.id = elementId;
            messageBubble.innerText = text;

            messageContainer.appendChild(messageBubble);
            chatContainer.appendChild(messageContainer);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageBubble;
        }

        function addLoadingIndicator() {
            const loadingHtml = `<div class="loading-dots"><span></span><span></span><span></span></div>`;
            const loadingBubble = addMessage('', 'ai', 'loading-indicator');
            loadingBubble.innerHTML = loadingHtml;
            return loadingBubble;
        }

        async function sendMessage() {
            const query = userInput.value.trim();
            const apiUrl = apiUrlInput.value.trim();
            const apiKey = apiKeyInput.value.trim();

            if (!query) return;
            if (!apiUrl || !apiKey) {
                alert('请先在顶部展开配置，并设置 API URL 和 API Key！');
                return;
            }

            addMessage(query, 'user');
            userInput.value = '';
            userInput.disabled = true;
            sendButton.disabled = true;

            const loadingIndicator = addLoadingIndicator();

            try {
                const response = await fetch(`${apiUrl}/chat-messages`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        inputs: {}, query: query, user: "zeabur-user",
                        response_mode: "streaming", conversation_id: conversationId || undefined
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'API 请求失败');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let aiMessageBubble = null;
                
                chatContainer.removeChild(loadingIndicator.parentElement);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonData = JSON.parse(line.substring(6));
                                if (jsonData.event === 'message') {
                                    fullResponse += jsonData.answer;
                                    if (!aiMessageBubble) {
                                        aiMessageBubble = addMessage(fullResponse, 'ai');
                                    } else {
                                        aiMessageBubble.innerText = fullResponse;
                                    }
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                                if (jsonData.event === 'agent_message' || jsonData.event === 'message_end') {
                                    conversationId = jsonData.conversation_id;
                                }
                            } catch (e) { /* 忽略无法解析的 JSON */ }
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                chatContainer.removeChild(loadingIndicator.parentElement);
                addMessage(`出错了: ${error.message}`, 'ai');
            } finally {
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
            }
        }
    </script>
</body>
</html>
