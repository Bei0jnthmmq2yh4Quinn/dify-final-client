<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dify API 对话客户端（增强版）</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f5f7fb; }
    header, footer { background: #fff; padding: 10px; border-bottom: 1px solid #ddd; }
    .wrap { max-width: 960px; margin: 0 auto; display: flex; gap: 8px; align-items: center; }
    .chat { max-width: 800px; margin: 20px auto; padding: 0 10px; display: flex; flex-direction: column; gap: 10px; }
    .bubble { padding: 10px 14px; border-radius: 14px; max-width: 75%; word-break: break-word; }
    .bubble.user { background: #3b82f6; color: #fff; align-self: flex-end; }
    .bubble.bot { background: #fff; color: #111; border: 1px solid #eee; align-self: flex-start; }
    .bubble.error { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; align-self: center; }
    textarea { width: 100%; min-height: 40px; padding: 8px; resize: vertical; }
    button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .btn { background: #3b82f6; color: #fff; }
    .btn.danger { background: #ef4444; color: #fff; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1 style="margin:0;font-size:18px;">Dify API 对话客户端 <small>(增强版)</small></h1>
      <input id="apiUrl" placeholder="API Base URL (默认 /api)" style="flex:1;padding:6px" />
      <input id="apiKey" type="password" placeholder="API Key (app-...)" style="padding:6px" />
      <button id="toggleKey">显示</button>
      <button id="saveBtn" class="btn">保存</button>
      <button id="useProxyBtn" class="btn">用本站代理</button>
    </div>
  </header>

  <main>
    <div id="chat" class="chat"></div>
  </main>

  <footer>
    <div class="wrap">
      <textarea id="msg" placeholder="输入你的问题... (Enter 发送 / Shift+Enter 换行)"></textarea>
      <button id="send" class="btn">发送</button>
      <button id="stop" class="btn danger" disabled>停止</button>
    </div>
  </footer>

  <script>
    const el = id => document.getElementById(id);
    const chatEl = el('chat');
    const msgEl = el('msg');
    const apiUrlEl = el('apiUrl');
    const apiKeyEl = el('apiKey');
    const sendBtn = el('send');
    const stopBtn = el('stop');
    const saveBtn = el('saveBtn');
    const toggleKeyBtn = el('toggleKey');
    const useProxyBtn = el('useProxyBtn');

    // 默认配置
    apiUrlEl.value = localStorage.getItem('dify-api-url') || '/api';
    apiKeyEl.value = localStorage.getItem('dify-api-key') || '';

    function toast(msg) { alert(msg); }

    function addBubble(role, text) {
      const div = document.createElement('div');
      div.className = 'bubble ' + role;
      div.innerText = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
      return div;
    }

    function saveConfig() {
      const url = (apiUrlEl.value || '').trim() || '/api';
      const key = (apiKeyEl.value || '').trim();
      if (!key) { toast('请填写 API Key'); return; }
      localStorage.setItem('dify-api-url', url);
      localStorage.setItem('dify-api-key', key);
      toast('配置已保存');
    }

    saveBtn.onclick = saveConfig;
    toggleKeyBtn.onclick = () => {
      apiKeyEl.type = apiKeyEl.type === 'password' ? 'text' : 'password';
      toggleKeyBtn.textContent = apiKeyEl.type === 'password' ? '显示' : '隐藏';
    };
    useProxyBtn.onclick = () => {
      apiUrlEl.value = '/api';
      toast('已设置 API URL: /api');
    };

    let controller = null;

    async function send() {
      const query = msgEl.value.trim();
      if (!query) return;
      const apiUrl = (apiUrlEl.value || '').trim() || '/api';
      const apiKey = (apiKeyEl.value || '').trim();
      if (!apiUrl || !apiKey) { toast('请先配置 API 信息'); return; }

      addBubble('user', query);
      msgEl.value = '';
      const botDiv = addBubble('bot', '...');
      sendBtn.disabled = true; stopBtn.disabled = false;

      try {
        controller = new AbortController();
        const resp = await fetch(`${apiUrl.replace(/\/$/, '')}/chat-messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({ query, inputs:{}, response_mode:'streaming', user:'web-user' }),
          signal: controller.signal
        });

        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '', answer = '';
        while (true) {
          const {done, value} = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, {stream:true});
          const parts = buffer.split("\n\n");
          buffer = parts.pop();
          for (const part of parts) {
            if (!part.startsWith('data: ')) continue;
            const data = JSON.parse(part.slice(6));
            if (data.event === 'message') {
              answer += data.answer || '';
              botDiv.innerText = answer;
            }
          }
        }
        botDiv.innerText = answer || '(无内容)';
      } catch(e) {
        botDiv.classList.add('error');
        botDiv.innerText = '出错了: ' + e.message;
      } finally {
        sendBtn.disabled = false; stopBtn.disabled = true;
        controller = null;
      }
    }

    sendBtn.onclick = send;
    stopBtn.onclick = () => { controller?.abort(); toast('已停止'); };
    msgEl.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>
